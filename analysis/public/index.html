<!doctype>
<html>
    <head>
        <script src="/vendor/d3.min.js"></script>
        <script src="/vendor/mqtt.js"></script>
        <script src="/vendor/rickshaw/rickshaw.min.js"></script>
        <script src="/js/jquery.min.js"></script>
        <script src="/js/jquery-ui.min.js"></script>
        <script src="/js/reactor.js"></script>
        <script src="/js/graph.js"></script>
        <script src="/js/ui.js"></script>

        <link rel="stylesheet" href="/vendor/rickshaw/rickshaw.min.css" />
        <link rel="stylesheet" href="/css/jquery-ui.min.css" />

		<style>
            body {
            }
			#chart_container {
				position: relative;
				font-family: Arial, Helvetica, sans-serif;
                display: inline-block;
			}
			#chart {
				position: relative;
				left: 2rem;
                top: 1rem;
			}
			#y_axis_alt {
				position: absolute;
				top: 0;
				bottom: 0;
				width: 2rem;
			}
			#y_axis_acc {
				position: absolute;
				top: 0;
				bottom: 0;
                left: calc(1000px + 2rem);
                width: 2rem;
			}
			#y_axis_gyr {
                display: none;
				position: absolute;
				top: 0;
				bottom: 0;
                left: calc(1000px + 2rem + 2rem);
                width: 2rem;
			}

            #legend {
                display: inline-block;
                vertical-align: top;
                margin: 0 0 0 6rem;
            }
            #config {
                margin-top: 2rem;
                font-size: 2rem;
            }
            .server div, .server button {
                display: inline-block;
            }
            .server div {
                width: 20rem;
            }
            .server div input {
                width: 100%;
            }


		</style>
    </head>
    <body>

		<div id="chart_container">
            <div id="y_axis_alt">Alt</div>
            <div id="chart"></div>
            <div id="y_axis_acc">Acc</div>
            <div id="y_axis_gyr">Gyr</div>
        </div>
        <div id="legend"></div>
        <div id="slider"></div>

        <div id="config">
            <div class="server">
                <div><input id="hostname" type="text" placeholder="MQTT Server eg iot.eclipse.org"/></div>
                <div><input id="topic" type="text" placeholder="myid/rocket_surgery"></div>
                <button id="connect">Connect</button>
                <button id="state">Waiting</button>
                <button id="reset">Reset</button>
            </div>
            <button id="download">Download data</button>
        </div>

        <script>
            let reactor = new Reactor();
            reactor.registerEvent('connect');
            reactor.registerEvent('disconnect');
            reactor.registerEvent('data_reset');

            let grapher = new Grapher();
            let ui = new UI({ reactor: reactor });
            let client = null;

            reactor.addEventListener('connect', (e) => {
                client = mqtt.connect("ws://" + ui.mqtt.host);
                client.subscribe(ui.mqtt.topic);

                // set up the handlers for the mqtt client.
                client.on("connect", () => {
                    ui.set_state('running');
                });

                client.on("message", (topic, payload) => {
                    let data = JSON.parse(payload.toString());
                    if (ui.state == ui.STATES.RUNNING) {
                        grapher.add_data(data);
                    }
                });
            });

            reactor.addEventListener('disconnect', () => {
                client.end(null, () => {
                    ui.set_state('waiting');
                });
            });

            reactor.addEventListener('data_reset', () => {
                console.log('resetting');
                grapher.reset();
            });

        </script>

    </body>
</html>
